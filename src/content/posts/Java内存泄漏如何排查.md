---
title: Java内存泄漏排查与性能调优实践指南
author: Jinx
pubDate: 2023-12-05
slug: java-memory-leak-troubleshooting-guide
featured: true
draft: false
categories:
  - java
tags:
  - JVM调优
  - 内存泄漏
  - 性能监控
  - GC分析
description: 深入解析Java应用中的内存泄漏问题，包括内存溢出与内存泄漏的区别、JVM监控工具使用(jps、jstat、jmap)、Full GC分析以及实际案例的排查流程与解决方案
---

<!-- more -->

## JVM第一篇：一个Java内存泄漏的排查案例

最近在看《深入理解Java虚拟机：JVM高级特性与最佳实践》（第二版）这本书，理论+实践结合，深入浅出，强烈推荐给大家。  
这两天在“小怪的java群”里面也对JVM内容进行了一个讨论，讨论的内容主要包括如下几个方面：  
1）内存溢出和内存泄露的介绍？  
2）如何排查和处理内存泄露？

### 一、内存溢出和内存泄露

一种通俗的说法。  
1、内存溢出：你申请了10个字节的空间，但是你在这个空间写入11或以上字节的数据，出现溢出。  
2、内存泄漏：你用new申请了一块内存，后来很长时间都不再使用了（按理应该释放），但是因为一直被某个或某些实例所持有导致 GC 不能回收，也就是该被释放的对象没有释放。

下面具体介绍。

#### 1.1 内存溢出

java.lang.OutOfMemoryError，是指程序在申请内存时，没有足够的内存空间供其使用，出现OutOfMemoryError。  
**产生原因**  
产生该错误的原因主要包括：

1.  JVM内存过小。
2.  程序不严密，产生了过多的垃圾。

**程序体现**  
一般情况下，在程序上的体现为：

1.  内存中加载的数据量过于庞大，如一次从数据库取出过多数据。
2.  集合类中有对对象的引用，使用���后未清空，使得JVM不能回收。
3.  代码中存在死循环或循环产生过多重复的对象实体。
4.  使用的第三方软件中的BUG。
5.  启动参数内存值设定的过小。

**错误提示**  
此错误常见的错误提示：  
`tomcat:java.lang.OutOfMemoryError: PermGen space`  
`tomcat:java.lang.OutOfMemoryError: Java heap space`  
`weblogic:Root cause of ServletException java.lang.OutOfMemoryError`  
`resin:java.lang.OutOfMemoryError`  
`java:java.lang.OutOfMemoryError`

**解决方法**

1.  增加JVM的内存大小  
    对于tomcat容器，找到tomcat在电脑中的安装目录，进入这个目录，然后进入bin目录中，在window环境下找到bin目录中的catalina.bat，在linux环境下找到catalina.sh。  
    编辑catalina.bat文件，找到JAVA_OPTS（具体来说是 `set "JAVA_OPTS=%JAVA_OPTS% %LOGGING_MANAGER%"`）这个选项的位置，这个参数是Java启动的时候，需要的启动参数。  
    也可以在操作系统的环境变量中对JAVA_OPTS进行设置，因为tomcat在启动的时候，也会读取操作系统中的环境变量的值，进行加载。  
    如果是修改了操作系统的环境变量，需要重启机器，再重启tomcat，如果修改的是tomcat配置文件，需要将配置文件保存，然后重启tomcat，设置就能生效了��
2.  优化程序，释放垃圾  
    主要思路就是避免程序体现上出现的情况。避免死循环，防止一次载入太多的数据，提高程序健壮型及时释放。因此，从根本上解决Java内存溢出的唯一方法就是修改程序，及时地释放没用的对象，释放内存空间。

#### 1.2 内存泄露

Memory Leak，是指程序在申请内存后，无法释放已申请的内存空间，一次内存泄露危害可以忽略，但内存泄露堆积后果很严重，无论多少内存，迟早会被占光。  
在Java中，内存泄漏就是存在一些被分配的对象，这些对象有下面两个特点：  
1）首先，这些对象是可达的，即在有向图中，存在通路可以与其相连；  
2）其次，这些对象是无用的，即程序以后不会再使用这些对象。  
如果对象满足这两个条件，这些对象就可以判定为Java中的内存泄漏，这些对象不会被GC所回收，然而它却占用内存。

关于内存泄露的处理页就是提高程序的健壮型，因为内存泄露是纯代码层面的问题。

#### 1.3 内存溢出和内存泄露的联系

内存泄露会最终会导致内存溢出。  
相同点：都会导致应用程序运行出现问题，性能下降或挂起。  
不同点：1) 内存泄露是导致内存溢出的原因之��，内存泄露积累起来将导致内存溢出。2) 内存泄露可以通过完善代码来避免，内存溢出可以通过调整配置来减少发生频率，但无法彻底避免。

### 二、一个Java内存泄漏的排查案例

某个业务系统在一段时间突然变慢，我们怀疑是因为出现内存泄露问题导致的，于是踏上排查之路。

#### 2.1 确定频繁Full GC现象

首先通过“虚拟机进程状况工具：jps”找出正在运行的虚拟机进程，最主要是找出这个进程在本地虚拟机的唯一ID（LVMID，Local Virtual Machine Identifier），因为在后面的排查过程中都是需要这个LVMID来确定要监控的是哪一个虚拟机进程。  
同时，对于本地虚拟机进程来说，LVMID与操作系统的进程ID（PID，Process Identifier）是一致的，使用Windows的任务管理器或Unix的ps命令也可以查询到虚拟机进程的LVMID。  
jps命令格式为：  
`jps [ options ] [ hostid ]`  
使用命令如下：  
使用jps：`jps -l`  
使用ps：`ps aux | grep tomat`

找到你需要监控的ID（假设为20954），再利用“虚拟机统计信息监视工具：jstat”监视虚拟机各种运行状态信息。  
jstat命令格式为：  
`jstat [ option vmid [interval[s|ms] [count]] ]`  
使用命令如下：  
`jstat -gcutil 20954 1000`  
意思是每1000毫秒查询一次，一直查。gcutil的意思是已使用空间站总空间的百分比。  
结果如下图：

jstat执行结果

查询结果表明：这台服务器的新生代Eden区（E，表示Eden）使用了28.30%（最后）的空间，两个Survivor区（S0、S1，表示Survivor0、Survivor1）分别是0和8.93%，老年代（O，表示Old）使用了87.33%。程序运行以来共发生Minor GC（YGC，表示Young GC）101次，总耗时1.961秒，发生Full GC（FGC，表示Full GC）7次，Full GC总耗时3.022秒，总的耗时（GCT，表示GC Time）为4.983秒。

#### 2.2 找出导致频繁Full GC的原因

分析方法通常有两种：  
1）把堆dump下来再用MAT等工具进行分析，但dump堆要花较长的时间，并且文件巨大，再从服务器上拖回本地导入工具，这个过程有些折腾，不到万不得已最好别这么干。  
2）更轻量级的在线分析，使用“Java内存影像工具：jmap”生成堆转储快照（一般称为headdump或dump文件）。  
jmap命令格式：  
`jmap [ option ] vmid`  
使用命令如下：  
`jmap -histo:live 20954`  
查看存活的对象情况，如下图所示：

存活对象

按照一位IT友的说法，数据不正常，十有八九就是泄露的。在我这个图上对象还是挺正常的。

我在网上找了一位博友的不正常数据，如下：

image.png

可以看出HashTable中的元素有5000多万，占用内存大约1.5G的样子。这肯定不正常。

#### 2.3 定位到代码

定位带代码，有很多种方法，比如前面提到的通过MAT查看Histogram即可找出是哪块代码。——我以前是使用这个方法。  
也可以使用BTrace，我没有使用过。

最后编辑于

：2020.05.16 17:54:35

- 序言：七十年代末，一起剥皮案震惊了整个滨河市，随后出现的几起案子，更是在滨河造成了极大的恐慌，老刑警刘岩，带你破解...

  [沈念sama](https://www.jianshu.com/u/dcd395522934)阅读 130,942评论 1赞 261

- 序言：滨河连续发生了三起死亡事件，死亡现场离奇诡异，居然都是意外死亡，警方通过查阅死者的电脑和手机，发现死者居然都...
- 文/潘晓璐 我一进店门，熙熙楼的掌柜王于贵愁眉苦脸地迎上来，“玉大人，你说我怎么就摊上这事。” “怎么了？”我有些...
- 文/不坏的土叔 我叫张陵，是天一观的道长。 经常有香客问我，道长，这世上最难降的妖魔是什么？ 我笑而不...
- 正文 为了忘掉前任，我火速办了婚礼，结果婚礼上，老公的妹妹穿的比我还像新娘。我一直安慰自己，���们只是感情好，可当我...

  [茶点故事](https://www.jianshu.com/u/0f438ff0a55f)阅读 45,896评论 1赞 227

- 文/花漫 我一把揭开白布。 她就那样静静地躺着，像睡着了一般。 火红的嫁衣衬着肌肤如雪。 梳的纹丝不乱的头发上，一...
- 那天，我揣着相机与录音，去河边找鬼。 笑死，一个胖子当着我的面吹牛，可吹牛的内容都是我干的。 我是一名探鬼主播，决...
- 文/苍兰香墨 我猛地睁开眼，长吁一口气：“原来是场噩梦啊……” “哼！你这毒妇竟也来了？” 一声冷哼从身侧响起，我...
- 想象着我的养父在大火中拼命挣扎，窒息，最后皮肤化为焦炭。我心中就已经是抑制不住地欢快，这就叫做以其人之道，还治其人...
- 序言：老挝万荣一对情侣失踪，失踪者是张志新（化名）和其女友刘颖，没想到半个月后，有当地人在树林里发现了一具尸体，经...
- 正文 独居荒郊野岭守林人离奇死亡，尸身上长有42处带血的脓包…… 初始之章·张勋 以下内容为张勋视角 年9月15日...

  [茶点故事](https://www.jianshu.com/u/0f438ff0a55f)阅读 28,336评论 2赞 187

- 正文 我和宋清朗相恋三年，在试婚纱的时候发现自己被绿了。 大学时的朋友给我发了我未婚���和他白月光在一起吃饭的照片。...

  [茶点故事](https://www.jianshu.com/u/0f438ff0a55f)阅读 29,581评论 1赞 198

- 白月光回国，霸总把我这个替身辞退。还一脸阴沉的警告我。\[不要出现在思思面前， 不然我有一百种方法让你生不如死。\]我...
- 序言：一个原本活蹦乱跳的男人离奇死亡，死状恐怖，灵堂内的尸体忽然破棺而出，到底是诈尸还是另有隐情，我是刑警宁泽，带...
- 正文 年R本政府宣布，位于F岛的核电站，受9级特大地震影响，放射性物质发生泄漏。R本人自食恶果不足惜，却给世界环境...

  [茶点故事](https://www.jianshu.com/u/0f438ff0a55f)阅读 30,425评论 3赞 186

- 文/蒙蒙 一、第九天 我趴在偏房一处隐蔽的房顶上张望。 院中可真热闹，春花似锦、人声如沸。这庄子的主人今日做“春日...
- 文/苍兰香墨 我抬头看了看天上的太阳。三九已至，却和暖如春，着一层夹袄步出监牢的瞬间，已是汗流浃背。 一阵脚步声响...
- 我被黑心中介骗来泰国打工， 没想到刚下飞机就差点儿被人妖公主榨干…… 1. 我叫王不留，地道东北人。 一个月前我还...
- 正文 我出身青楼，却偏偏与公主长得像，于是被迫代替她去往敌国和亲。 传闻我���和亲对象是个残疾皇子，可洞房花烛夜当晚...

  [茶点故事](https://www.jianshu.com/u/0f438ff0a55f)阅读 32,211评论 2赞 202

### 推荐阅读[更多精彩内容](https://www.jianshu.com/)

- 从三月份找实习到现在，面了一些公司，挂了不少，但最终还是拿到小米、百度、阿里、京东、新浪、CVTE、乐视家的研发岗...

  [时芥蓝](https://www.jianshu.com/u/bd4811478d4b)阅读 41,891评论 11赞 349

- 前言： 在遨游了一番 Java Web 的世界之后，发现了自己的一些缺失，所以就着一篇深度好文：知名互联网公司校招...
- 在 Java 中，内存的分配是由程序完成的，而内存的释放则是由 Garbage Collecation(GC) 完...
- 学习之前需要了解几个内容： 1.Scala目前的地位 大数据而生 2.Scala可以做什么 spark底层代码是s...
- 时间使用率有点低，这么忙又毫无成果，把自己一天时间进行整理，时间花费较多项目进行思考及调整，有些事务是否需要自...

